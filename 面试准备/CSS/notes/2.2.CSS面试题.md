## 游览器的重排（回流）与重绘

**总结：** **回流必将引起重绘，重绘不一定会引起回流。**

### 重排/回流：

* 定义：当元素中部分或全部元素的尺寸、结构、或某些属性发生改变时，浏览器重新渲染部分或全部文档的过程称为回流。

* 会导致回流的操作：

  * 页面首次渲染
  * 浏览器窗口大小发生改变
  * 元素尺寸或位置发生改变
  * 元素内容变化（文字数量或图片大小等等）
  * 元素字体大小变化
  * 添加或者删除**可见**的`DOM`元素
  * 激活`CSS`伪类（例如：`:hover`）
  * 查询某些属性或调用某些方法

* 常用且会导致回流的属性和方法：

  * ```
    clientWidth`、`clientHeight`、`clientTop`、`clientLeft
    offsetWidth`、`offsetHeight`、`offsetTop`、`offsetLeft
    scrollWidth`、`scrollHeight`、`scrollTop`、`scrollLeft
    scrollIntoView()`、`scrollIntoViewIfNeeded()
    getComputedStyle()
    getBoundingClientRect()
    scrollTo()
    ```

### 重绘

* 定义：当页面中元素样式的改变并不影响它在文档流中的位置时（例如：`color`、`background-color`、`visibility`等），浏览器会将新样式赋予给元素并重新绘制它，这个过程称为重绘。

### 性能影响

**回流比重绘的代价要更高。**

* 现代浏览器会对频繁的回流或重绘操作进行优化：**浏览器会维护一个队列，把所有引起回流和重绘的操作放入队列中，如果队列中的任务数量或者时间间隔达到一个阈值的，浏览器就会将队列清空，进行一次批处理，这样可以把多次回流和重绘变成一次。**

* 当你访问以下属性或方法时，浏览器会立刻清空队列：

* ```
  clientWidth`、`clientHeight`、`clientTop`、`clientLeft
  offsetWidth`、`offsetHeight`、`offsetTop`、`offsetLeft
  scrollWidth`、`scrollHeight`、`scrollTop`、`scrollLeft
  width`、`height
  getComputedStyle()
  getBoundingClientRect()
  ```

### 如何优化减少重排和重绘的次数

* **集中改变样式**
  我们往往通过改变class的方式来集中改变样式

```js
// 判断是否是黑色系样式
const theme = isDark ? 'dark' : 'light'

// 根据判断来设置不同的class
ele.setAttribute('className', theme)
复制代码
```

* **使用DocumentFragment**
  我们可以通过**[createDocumentFragment](https://developer.mozilla.org/zh-CN/docs/Web/API/DocumentFragment)**创建一个游离于DOM树之外的节点，然后在此节点上批量操作，最后插入DOM树中，因此只触发一次重排

* ```js
  var fragment = document.createDocumentFragment();
  
  for (let i = 0;i<10;i++){
    let node = document.createElement("p");
    node.innerHTML = i;
    fragment.appendChild(node);
  }
  
  document.body.appendChild(fragment);
  ```

* 尽量避免在遍历循环中，进行元素offsetTop 等样式值的获取操作
* 利用 `transform` 实现动画变化效果，去代替`left top`的变换(轮播图等)








## CSS选择器的匹配规则

**css选择器是从右向左匹配的**

例如：

```css
.mod-nav h3 span {
            font-style: 16px;
        }
```

```html
<div class="mod-nav">
        <header>
            <h3>
                <span>标题</span>
            </h3>
        </header>
    </div>

    <div>
        <ul>
            <li>项目一</li>
            <li>项目一</li>
            <li>项目一</li>
            <li>项目一</li>
        </ul>
    </div>
```

CSS解析器将CSS解析为CSS规则树，比如对于`.mod-nav h3 span`，会以`span`为根节点并指向`h3`，`h3`在指向`.mod-nav`类节点。

1. 先找到所有的`span`节点,然后基于每一个`span`再向上查找`h3`
2. 由`h3`再向上查找`.mod-nav`的节点
3. 最后触及根元素`html`结束该分支遍历...

